<!-- quetzal/quetzal_app/elements/image_frame_component/index.html -->
<!DOCTYPE html>
<html>

<head>
    <link href="https://unpkg.com/image-compare-viewer/dist/image-compare-viewer.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0px;
            display: flex;
            flex-direction: row;
            font-family: sans-serif;
            justify-content: space-between;
        }

        .content {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-between;
            padding: 1rem;

        }

        .title {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0.5rem;
        }

        .caption,
        .label {
            margin: 0;
        }

        .card {
            background: transparent;
            border-style: solid;
            /* border-width: 1px; */
            border-color: #e0e0e0;
            /* border-radius: 0.7rem; */
        }

        /* #image-compare {
            border-top-right-radius: 0.65rem;
            border-top-left-radius: 0.65rem;
        } */
    </style>
    <style id="custom-style"></style>
    <style id="custom-style0"></style>
    <style id="custom-style1"></style>
</head>

<body id="card-body">
    <div id="card-body0">
        <div class="title" id="label-container0">
            <p class="label"></p>
        </div>
        <div class="card0" id="frame-card0">
            <div id="image-compare0"></div>
            <div class="content" , id="caption-container0">
                <p class="caption"></p>
            </div>
        </div>
    </div>

    <div id="card-body1">
        <div class="title" id="label-container1">
            <p class="label"></p>
        </div>
        <div class="card1" id="frame-card1">
            <div id="image-compare1"></div>
            <div class="content" id="caption-container1">
                <p class="caption"></p>
            </div>
        </div>
    </div>
</body>

<script src="https://unpkg.com/image-compare-viewer/dist/image-compare-viewer.min.js"></script>
<script type="text/javascript">
    // ----------------------------------------------------
    // These functions should be used as is to perform required Streamlit 
    // component lifecycle actions:
    //
    // 1. Signal Streamlit client that component is ready
    // 2. Signal Streamlit client to set visible height of the component
    //    (this is optional, in case Streamlit doesn't correctly auto-set it)
    // 3. Pass values from component to Streamlit client
    //

    // Helper function to send type and data messages to Streamlit client
    const SET_COMPONENT_VALUE = "streamlit:setComponentValue"
    const RENDER = "streamlit:render"
    const COMPONENT_READY = "streamlit:componentReady"
    const SET_FRAME_HEIGHT = "streamlit:setFrameHeight"

    function _sendMessage(type, data) {
        var outboundData = Object.assign({
            isStreamlitMessage: true,
            type: type,
        }, data)

        window.parent.postMessage(outboundData, "*")
    }

    function initialize(pipeline) {
        window.addEventListener("message", (event) => {
            if (event.data.type == RENDER) {
                // The event.data.args dict holds any JSON-serializable value
                // sent from the Streamlit client. It is already deserialized.
                pipeline.forEach(handler => {
                    handler(event.data.args)
                })
            }
        })

        _sendMessage(COMPONENT_READY, { apiVersion: 1 });

        window.addEventListener('load', adjustSize);
        window.addEventListener('resize', adjustSize);
    }

    function adjustSize() {
        var container = document.getElementById("card-body");
        var rect = container.getBoundingClientRect();
        setFrameHeight(rect.height);
    }

    function setFrameHeight(height) {
        _sendMessage(SET_FRAME_HEIGHT, { height: height })
    }

    function notifyHost(data) {
        _sendMessage(SET_COMPONENT_VALUE, data)
    }

    function initializeProps_Handler(props) {
        var bottomRadius = "0rem";
        var bgColor = "#FFFFFF";
        var textColor = "#212121"

        if (props.dark_mode) {
            bgColor = "#424242";
            textColor = "#FFFFFF";
        }

        // iterate and set the two elements
        for (let i = 0; i < props.labels.length; i++) {
            // Append Label
            const card = document.getElementById(`card-body${i}`)
            const labelContainer = document.getElementById(`label-container${i}`);
            if (props.labels[i] === "") {
                labelContainer.remove()
            } else {
                labelContainer.innerHTML = '';  // Clear existing captions
                const labelDiv = document.createElement('div');
                const labelParagraph = document.createElement('p');
                labelParagraph.className = 'label';
                labelParagraph.innerText = props.labels[i];
                labelDiv.appendChild(labelParagraph);
                labelContainer.appendChild(labelDiv);
            }

            // Update Image
            const imageContainer = document.getElementById(`image-compare${i}`);
            if (props.image_urls[i].length === 1) {
                imageContainer.innerHTML =
                    `<img src="${props.image_urls[i][0]}" id=image-content${i}"
                    alt="" 
                    style="
                        width: 100%; 
                        border-top-right-radius: ${props.image_border_radius}; 
                        border-top-left-radius: ${props.image_border_radius};
                        margin-bottom: -4px;
                    "
                />`;
            } else if (props.image_urls[i].length === 2) {
                imageContainer.innerHTML = `
                    <img src="${props.image_urls[i][0]}" alt="" />
                    <img src="${props.image_urls[i][1]}" alt="" />
                `;
                const options = {
                    startingPoint: props.starting_point,
                    controlColor: bgColor,
                };
                new ImageCompare(imageContainer, options).mount();
            } else {
                imageContainer.innerHTML = ""
            }

            // Append Captions
            const captionsContainer = document.getElementById(`caption-container${i}`);
            if (props.captions[i].length === 0) {
                captionsContainer.remove() // This hides the container
                bottomRadius = props.image_border_radius;
                props.border_width = "0px";
            } else {
                captionsContainer.innerHTML = '';  // Clear existing captions
                props.captions[i].forEach(captionText => {
                    const captionDiv = document.createElement('div');
                    const captionParagraph = document.createElement('p');
                    captionParagraph.className = 'caption';
                    captionParagraph.innerText = captionText;
                    captionDiv.appendChild(captionParagraph);
                    captionsContainer.appendChild(captionDiv);
                });
            }

            // Set custom styles
            const customStyle = document.getElementById(`custom-style${i}`);

            customStyle.innerHTML = `
                #card-body${i} {
                    padding: ${props.padding};
                    font-family: ${props.font_family};
                }
                #image-compare${i} {
                    border-top-right-radius: ${props.image_border_radius};
                    border-top-left-radius: ${props.image_border_radius};
                    border-bottom-left-radius: ${bottomRadius};
                    border-bottom-right-radius: ${bottomRadius};
                    width: 100%;
                }

                #image-content${i}{
                    border-top-right-radius: ${props.image_border_radius};
                    border-top-left-radius: ${props.image_border_radius};
                    border-bottom-left-radius: ${bottomRadius};
                    border-bottom-right-radius: ${bottomRadius};
                    width: 100%;
                }
            `;
        }

        const customStyleShared = document.getElementById(`custom-style`);
        customStyleShared.innerHTML = `
                .card {
                    border-radius: ${props.card_border_radius};
                    border-width: ${props.border_width};
                    background-color: ${bgColor};
                    color: ${textColor};
                }
            `;

    }

    function log_Handler(props) {
        console.log("Received from Streamlit: " + JSON.stringify(props))
    }

    let pipeline = [initializeProps_Handler, log_Handler];
    initialize(pipeline);
</script>

</html>